<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Distribution</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
</head>

<body>
    <div id="editor"></div>
    <input id="stdin" type="text" placeholder="Type here and press Enter" />
    <div id="stdout"></div>
    <div id="stderr"></div>
    <button id="run">Run</button>

    <script>
        const demoAString = `; demoA.a: simple program assembly/execution and test input/output caching
    mov r0, 5
    dout r0
    nl
    halt`;

        const editor = CodeMirror(document.getElementById("editor"), {
            value: demoAString,
            mode: "lcc",
            theme: "material",
            lineNumbers: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: true,
            lineWrapping: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            autoCloseBrackets: true,
            matchBrackets: true,
            autoCloseTags: true,
            matchTags: true,
            foldGutter: true,
            extraKeys: {
                "Ctrl-Space": "autocomplete",
                "Ctrl-S": function (cm) {
                    console.log(cm.getValue());
                }
            }
        });

        let worker = new Worker("worker.js");

        // Handle messages from the worker
        worker.onmessage = function (event) {
            const { type, data } = event.data;
            if (type === "stdout") {
                document.getElementById("stdout").textContent += data;
            } else if (type === "stderr") {
                document.getElementById("stderr").textContent += data;
            } else if (type === "exit") {
                console.log("LCC process exited with code:", data);
            }
        };

        document.getElementById("run").addEventListener("click", function () {
            softInitUI();

            const filePath = "demoA.a";
            const code = editor.getValue();
            const name = "lettuce";

            // Send code to worker
            worker.postMessage({
                type: "run",
                payload: { code, filePath, name }
            });
        });

        function softInitUI() {
            document.getElementById("stdout").textContent = "";
            document.getElementById("stderr").textContent = "";
        }
    </script>
</body>

</html>
