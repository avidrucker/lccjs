<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Distribution</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/theme/darcula.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror-one-dark-theme@1.1.1/one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.7/mode/z80/z80.min.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        html,body {
            height: 100vh;
            background-color: #353232;
            margin: 0;
        }
        #app {
            height: 100%;
        }
        #editor {
            flex-shrink: 1;
            height: 60vh;
            max-height: 60vh;
        }
        .CodeMirror{
            height: 60vh;
            max-height: 60vh;
        }

        #stdout,
        #stderr {
            color: white;
            font-family: monospace;
            white-space: pre;
            overflow: auto;
            background-color: #353232;
            border: 1px solid rgba(255, 255, 255, 0.5);
            flex-grow: 1;
            min-height: 2em;
            position: relative;
        }

        #run {
            width: 100%;
        }

        #input-container {
            display: flex;
        }

        #stdin {
            flex-grow: 1;
        }

        .label {
            font-style: italic;
            font-weight: lighter;
            position: absolute;
            right: calc(2em);
            top: 0;
            opacity: 0.5;
        }

        .app-footer {
            height: 35vh;
            display: flex;
            flex-direction: column;
            max-height: 35vh;
        }
        
        #app-inner {
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="app">
        <div id="app-inner">
            <div id="editor"></div>
            <footer class="app-footer">
                <button id="run">Run</button>
                <div id="input-container">
                    <input id="stdin" type="text" placeholder="Type here and press Enter" />
                    <button id="enter">enter</button>
                </div>
                <div id="stdout">
                    <div class="label">output</div>
                </div>
                <div id="stderr">
                    <div class="label">errors</div>
                </div>
            </footer>
        </div>
    </div>

    <script>
        const demoAString = `; WelcomeProg.a This is a program that reads a name from the user and prints a greeting.
            lea r0, prompt
            sout r0
            lea r0, buffer
            sin r0
            lea r1, hi
            sout r1
            sout r0
            nl
            m
            halt
prompt:     .string "Name: "
hi:         .string "Hi "
buffer:     .zero 10"`;

        const editor = CodeMirror(document.getElementById("editor"), {
            value: demoAString,
            mode: "z80", // TODO: change to lcc
            // dark theme
            theme: "darcula",
        
            lineNumbers: true,
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: true,
            lineWrapping: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            autoCloseBrackets: true,
            matchBrackets: true,
            autoCloseTags: true,
            matchTags: true,
            foldGutter: true,
            extraKeys: {
                "Ctrl-Space": "autocomplete",
                "Ctrl-S": function (cm) {
                    console.log(cm.getValue());
                }
            }
        });
        let randomnumber = Math.floor(Math.random() * 1000000); 
        // For cache invalidation while testing
        let worker = new Worker("worker.js" + "?v=" + randomnumber);

        // Create Shared Buffers
        const inputBuffer = new SharedArrayBuffer(256); // Shared memory for input
        const inputIndex = new SharedArrayBuffer(4);    // Index for read/write

        worker.postMessage({
            inputBuffer: inputBuffer,
            inputIndex: inputIndex
        });

        const inputView = new Uint8Array(inputBuffer);
        const indexView = new Int32Array(inputIndex);

        // Handle messages from the worker
        worker.onmessage = function (event) {
            const { type, data } = event.data;
            if (type === "stdout") {
                document.getElementById("stdout").textContent += data;
            } else if (type === "stderr") {
                document.getElementById("stderr").textContent += data;
            } else if (type === "exit") {
                console.log("LCC process exited with code:", data);
                document.getElementById("stderr").textContent += `LCC process exited with code: ${data}\n`;
            }
        };

        document.getElementById("run").addEventListener("click", function () {
            softInitUI();

            const filePath = "demoA.a";
            const code = editor.getValue();
            const name = "lettuce";

            // Send code to worker
            worker.postMessage({
                type: "run",
                payload: { code, filePath, name }
            });
        });

        function onEnter() {
            const stdin = document.getElementById("stdin").value;
                document.getElementById("stdin").value = "";
                console.log("Sending stdin to worker:", stdin);

                // Encode input string into the shared buffer
                const encoded = new TextEncoder().encode(stdin + '\n');
                inputView.set(encoded, 0); // Write input to buffer
                Atomics.store(indexView, 0, encoded.length); // Store input length

                // Notify Worker of new input
                Atomics.notify(indexView, 0);
        }

        document.getElementById('enter').addEventListener('click', onEnter);

        document.getElementById("stdin").addEventListener("keyup", function (event) {
            if (event.key === "Enter") {
                event.preventDefault();
                onEnter();
            }
        });

        function softInitUI() {
            document.getElementById("stdout").textContent = "";
            document.getElementById("stderr").textContent = "";
        }
    </script>
</body>

</html>